<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebRTC Local Test</title>
<style>
  video { width: 45%; margin: 5px; border: 2px solid #444; border-radius: 8px; }
</style>
</head>
<body>
<h2>WebRTC Local Peer Test (Firefox â†” Chromium)</h2>
<video id="local" autoplay playsinline muted></video>
<video id="remote" autoplay playsinline></video>
<button id="startVideo">Start Video</button>

<script>
const ws = new WebSocket("wss://192.168.1.19:8080");
const pc = new RTCPeerConnection({
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

ws.onopen = () => console.log("Connected to signaling server.");


ws.onmessage = async (event) => {
  const msg = JSON.parse(event.data);

  if (msg.type === "offer") {
    await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ type: "answer", data: answer }));
  } else if (msg.type === "answer") {
    await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
  } else if (msg.type === "candidate") {
    await pc.addIceCandidate(msg.data);
  }
};

document.getElementById("startVideo").addEventListener("click", async () => {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
  .then(stream => {
    document.getElementById("local").srcObject = stream;
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
  })
  .catch(console.error);
  });

pc.onicecandidate = (event) => {
  if (event.candidate) {
    ws.send(JSON.stringify({ type: "candidate", data: event.candidate }));
  }
};

pc.ontrack = (event) => {
  document.getElementById("remote").srcObject = event.streams[0];
};

window.createOffer = async () => {
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type: "offer", data: offer }));
};
</script>

<button onclick="createOffer()">Start Offer</button>
</body>
</html>

